# 草稿上传问题解决方案

## 问题描述
后端接口已就绪：`POST /api/v1/drafts` - 保存草稿
但前端缺少对应的API调用方法：`apiService.createDraft`

## 解决方案

### 1. 添加 createDraft API方法
在 `utils/apiService.js` 中添加了 `createDraft` 方法：

```javascript
/**
 * 创建草稿
 */
async createDraft(draftData) {
  return await this.request(API_ENDPOINTS.DRAFTS, 'POST', {
    title: draftData.title || '',
    content: draftData.content || '',
    category: draftData.category || 'knowledge',
    tags: draftData.tags || []
  })
}
```

### 2. API方法特点
- **统一认证**: 使用Bearer Token进行身份验证
- **数据标准化**: 自动处理默认值，确保数据格式一致
- **错误处理**: 集成统一的错误处理机制
- **日志记录**: 包含详细的请求和响应日志

### 3. 使用示例

#### 基本用法
```javascript
const apiService = require('../../utils/apiService')

// 创建草稿
const draftData = {
  title: '我的草稿标题',
  content: '草稿内容...',
  category: 'knowledge',
  tags: ['标签1', '标签2']
}

try {
  const result = await apiService.createDraft(draftData)
  console.log('草稿创建成功:', result)
} catch (error) {
  console.error('草稿创建失败:', error)
}
```

#### 在笔记编辑器中使用
```javascript
// 在 pages/note-editor/note-editor.js 的 saveDraft 方法中
async saveDraft() {
  try {
    const draftData = {
      title: this.data.noteTitle || '无标题草稿',
      content: this.data.noteContent || '',
      category: this.data.selectedCategories[0] || 'knowledge',
      tags: this.data.tags || []
    }
    
    // 调用新的API方法
    const result = await apiService.createDraft(draftData)
    
    if (result.success) {
      // 保存成功，更新本地数据
      this.setData({ draftId: result.data.id })
      wx.showToast({ title: '草稿已保存', icon: 'success' })
    }
  } catch (error) {
    console.error('保存草稿失败:', error)
    wx.showToast({ title: '保存失败', icon: 'error' })
  }
}
```

### 4. API配置验证
确认 `utils/apiConfig.js` 中的端点配置正确：
```javascript
const API_ENDPOINTS = {
  // 草稿箱
  DRAFTS: '/drafts',
  DRAFT_PUBLISH: (id) => `/drafts/${id}/publish`,
  // ...
}
```

### 5. 测试页面
创建了测试页面 `pages/api-test-draft/` 用于验证API功能：
- **测试创建草稿**: 验证 `createDraft` 方法
- **测试获取草稿列表**: 验证 `getDrafts` 方法
- **实时结果显示**: 显示API调用结果和错误信息

### 6. 集成建议

#### 在现有草稿保存逻辑中集成
1. **保留本地存储**: 继续使用本地存储作为缓存
2. **添加云端同步**: 使用新的API方法同步到服务器
3. **错误降级**: API失败时回退到本地存储

#### 修改建议
```javascript
// 在 pages/note-editor/note-editor.js 中
async saveDraft() {
  const draft = {
    // ... 现有草稿数据
  }
  
  // 1. 保存到本地存储（现有逻辑）
  noteManager.setAccountStorage('drafts', drafts)
  
  // 2. 同步到云端（新增）
  try {
    const result = await apiService.createDraft(draft)
    if (result.success) {
      draft.serverId = result.data.id
      // 更新本地草稿，添加服务器ID
    }
  } catch (error) {
    console.warn('云端同步失败，使用本地存储:', error)
  }
}
```

## 技术细节

### 请求格式
```javascript
POST /api/v1/drafts
Authorization: Bearer <token>
Content-Type: application/json

{
  "title": "草稿标题",
  "content": "草稿内容",
  "category": "knowledge",
  "tags": ["标签1", "标签2"]
}
```

### 响应格式
```javascript
{
  "success": true,
  "message": "草稿创建成功",
  "data": {
    "id": "draft_123456",
    "title": "草稿标题",
    "content": "草稿内容",
    "category": "knowledge",
    "tags": ["标签1", "标签2"],
    "createTime": "2024-01-01T00:00:00.000Z",
    "updateTime": "2024-01-01T00:00:00.000Z"
  }
}
```

## 优势
1. **统一接口**: 与现有API架构保持一致
2. **错误处理**: 完善的错误处理和用户提示
3. **数据验证**: 自动处理默认值和数据格式
4. **可扩展性**: 易于添加新功能和字段
5. **测试友好**: 提供专门的测试页面

## 注意事项
1. 确保后端服务器正常运行
2. 用户需要先登录获取有效Token
3. 网络异常时会显示相应错误信息
4. 建议在WiFi环境下进行测试

## 下一步
1. 在笔记编辑器中集成新的API方法
2. 测试云端同步功能
3. 优化错误处理和用户体验
4. 添加离线模式支持
