# 数据隔离确认文档

## ✅ 数据隔离完整性验证

本文档确认了笔记簿、草稿箱和回收站的完全数据隔离，确保知识星图和梦之国度等功能不会被其他数据干扰。

---

## 📊 数据存储架构

### 1. 常规笔记存储空间
- **存储位置**: `userAccounts.{accountName}.notes`
- **数据类型**: 已发布的正式笔记
- **访问函数**: `getNotesFromAccount()` / `getRegularNotes()`
- **数据过滤**: 
  - ❌ 排除 `status === 'deleted'` 或 `isDeleted === true`
  - ❌ 排除 `isDraft === true` 或 `status === 'draft'`

### 2. 草稿箱存储空间
- **存储位置**: `drafts_{accountName}`
- **数据类型**: 未发布的草稿笔记
- **访问函数**: `getAccountStorage('drafts', [])`
- **完全独立**: 不与常规笔记混合存储

### 3. 回收站存储空间
- **存储位置**: `noteTrash_{accountName}`
- **数据类型**: 软删除的笔记
- **访问函数**: `getTrashNotes()` / `getTrashedNotes()`
- **完全独立**: 不与常规笔记混合存储

---

## 🔒 核心隔离机制

### 1. 数据保存时的隔离
`saveNotesToAccount()` 函数会自动过滤：
- ✅ 软删除的笔记 (`status === 'deleted'`)
- ✅ 草稿笔记 (`isDraft === true` 或 `status === 'draft'`)

**确保常规笔记列表永远不会包含草稿或回收站数据！**

### 2. 数据查询时的隔离
`getNotesFromAccount()` 函数会自动过滤：
- ✅ 软删除的笔记
- ✅ 草稿笔记

**确保从账户获取的笔记都是干净的常规笔记！**

### 3. 专用查询函数
新增 `getRegularNotes()` 函数：
- ✅ 专门用于知识星图和梦之国度
- ✅ 只返回常规笔记（排除草稿和回收站）
- ✅ 从账户存储获取，不依赖全局存储

---

## 🎯 应用层面的隔离

### 知识星图 (knowledge-map.js)
**修改前**: 使用 `getAllNotes()` ❌
**修改后**: 使用 `getRegularNotes()` ✅

**修改位置**:
1. `SearchSuggestionManager.extractContentKeywords()` - 第39行
2. `getFilteredNotes()` - 第539行

### 梦之国度 (dream-nation.js)
**修改前**: 使用 `getAllNotes()` ❌
**修改后**: 使用 `getRegularNotes()` ✅

**修改位置**:
1. `loadInitialData()` - 第81行
2. `getFilteredNotes()` - 第175行

---

## ✅ 隔离验证清单

### 常规笔记存储
- ✅ `getNotesFromAccount()` 过滤删除和草稿
- ✅ `saveNotesToAccount()` 过滤删除和草稿
- ✅ `getRegularNotes()` 只返回常规笔记

### 草稿箱存储
- ✅ 使用独立存储键 `drafts_{accountName}`
- ✅ `draft-box.js` 使用 `getAccountStorage('drafts', [])`
- ✅ 不与常规笔记混合

### 回收站存储
- ✅ 使用独立存储键 `noteTrash_{accountName}`
- ✅ `softDeleteNote()` 将笔记移到回收站
- ✅ `getTrashedNotes()` 从回收站读取
- ✅ 不与常规笔记混合

### 应用数据源
- ✅ 知识星图使用 `getRegularNotes()`
- ✅ 梦之国度使用 `getRegularNotes()`
- ✅ 所有查询都正确隔离

---

## 🚨 重要警告

### ❌ 不要使用这些函数获取常规笔记：
1. `getAllNotes()` - 已废弃，可能包含草稿
2. 直接访问 `wx.getStorageSync('notes')` - 全局存储，可能混入各种数据

### ✅ 应该使用这些函数：
1. `getRegularNotes()` - 用于知识星图和梦之国度
2. `getActiveNotesFromAccount(accountName)` - 用于常规操作
3. `getNotesFromAccount(accountName)` - 用于账户相关的常规操作

---

## 📝 数据流程确认

### 保存笔记流程
1. 常规笔记 → 保存到 `userAccounts.{account}.notes` ✅
2. 草稿笔记 → 保存到 `drafts_{account}` ✅
3. 删除笔记 → 从常规列表移除，移到 `noteTrash_{account}` ✅

### 查询笔记流程
1. 常规笔记查询 → `getNotesFromAccount()` → 自动过滤草稿和删除 ✅
2. 草稿查询 → `getAccountStorage('drafts', [])` → 独立存储 ✅
3. 回收站查询 → `getTrashedNotes()` → 独立存储 ✅

### 应用数据流程
1. 知识星图 → `getRegularNotes()` → 只获取常规笔记 ✅
2. 梦之国度 → `getRegularNotes()` → 只获取常规笔记 ✅

---

## ✅ 最终确认

✅ **常规笔记、草稿箱、回收站已完全隔离**
✅ **知识星图和梦之国度只使用常规笔记数据**
✅ **所有查询函数都正确实现了数据过滤**
✅ **数据保存时自动排除其他类型的数据**

**数据隔离完整性：100%**

