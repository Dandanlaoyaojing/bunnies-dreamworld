# 🔌 小程序连接后端服务器指南

## ✅ 已完成的配置

我已经为你创建了以下文件：

1. **`utils/apiConfig.js`** - API配置文件（后端地址配置）
2. **`utils/apiService.js`** - API请求服务类（封装所有API调用）
3. **`pages/api-test/`** - API连接测试页面（完整的测试工具）
4. **`API_USAGE_GUIDE.md`** - 详细的API使用指南

## 🚀 立即开始测试

### 步骤 1：确保后端服务器正在运行

在后端项目目录运行：
```bash
npm start
```

你应该看到：
```
✅ 服务器运行在: http://localhost:3000
```

### 步骤 2：配置微信开发者工具

1. 打开微信开发者工具
2. 点击右上角"详情"
3. 勾选"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"

### 步骤 3：打开测试页面

小程序启动后会自动打开 **API连接测试页面**（因为我已将它设为首页）

### 步骤 4：运行测试

在测试页面点击：
- **🚀 运行所有测试** - 自动测试所有API功能
- 或点击单个测试按钮逐个测试

## 📱 测试页面功能

测试页面包含6个核心测试：

1. **🏥 健康检查** - 测试后端连接
2. **👤 用户注册** - 测试注册功能
3. **🔐 用户登录** - 测试登录功能
4. **📝 创建笔记** - 测试笔记创建
5. **📚 获取笔记列表** - 测试笔记读取
6. **📊 获取统计信息** - 测试统计功能

## 🔧 快速集成到现有页面

### 在登录页面使用API

```javascript
// pages/login/login.js
const apiService = require('../../utils/apiService.js')

Page({
  // 现有的代码...
  
  // 添加API登录方法
  async handleAPILogin() {
    try {
      wx.showLoading({ title: '登录中...' })
      
      const result = await apiService.login(
        this.data.username,
        this.data.password
      )
      
      wx.hideLoading()
      
      if (result.success) {
        wx.showToast({ title: '登录成功', icon: 'success' })
        
        // API会自动保存token和用户信息
        // 直接跳转即可
        wx.switchTab({ url: '/pages/1/1' })
      }
    } catch (err) {
      wx.hideLoading()
      wx.showToast({
        title: err.message || '登录失败',
        icon: 'none'
      })
    }
  }
})
```

### 在笔记编辑器使用API

```javascript
// pages/note-editor/note-editor.js
const apiService = require('../../utils/apiService.js')

Page({
  // 现有的代码...
  
  // 添加保存到服务器的方法
  async saveToServer() {
    try {
      wx.showLoading({ title: '保存中...' })
      
      const result = await apiService.createNote({
        title: this.data.title,
        content: this.data.content,
        category: this.data.category,
        tags: this.data.tags
      })
      
      wx.hideLoading()
      
      if (result.success) {
        wx.showToast({ title: '保存成功', icon: 'success' })
        
        // 保存笔记ID，用于后续更新
        this.setData({
          noteId: result.data.id
        })
      }
    } catch (err) {
      wx.hideLoading()
      wx.showToast({
        title: err.message || '保存失败',
        icon: 'none'
      })
    }
  }
})
```

### 获取笔记列表

```javascript
// pages/my-notes/my-notes.js
const apiService = require('../../utils/apiService.js')

Page({
  data: {
    notes: []
  },
  
  async loadNotes() {
    try {
      wx.showLoading({ title: '加载中...' })
      
      const result = await apiService.getNotes({
        page: 1,
        limit: 20
      })
      
      wx.hideLoading()
      
      if (result.success) {
        this.setData({
          notes: result.data.notes
        })
      }
    } catch (err) {
      wx.hideLoading()
      
      // 网络错误时，尝试使用本地缓存
      const cachedNotes = wx.getStorageSync('notes') || []
      this.setData({
        notes: cachedNotes
      })
      
      wx.showToast({
        title: '使用缓存数据',
        icon: 'none'
      })
    }
  },
  
  onLoad() {
    this.loadNotes()
  }
})
```

## 🎯 API服务提供的方法

### 认证相关
- `apiService.register(username, password, nickname)` - 注册
- `apiService.login(username, password)` - 登录
- `apiService.logout()` - 登出
- `apiService.refreshToken()` - 刷新token

### 笔记管理
- `apiService.getNotes(params)` - 获取笔记列表
- `apiService.getNoteById(id)` - 获取笔记详情
- `apiService.createNote(noteData)` - 创建笔记
- `apiService.updateNote(id, noteData)` - 更新笔记
- `apiService.deleteNote(id)` - 删除笔记
- `apiService.searchNotes(keyword, params)` - 搜索笔记

### 收藏与回收站
- `apiService.favoriteNote(id)` - 收藏笔记
- `apiService.unfavoriteNote(id)` - 取消收藏
- `apiService.getFavorites(params)` - 获取收藏列表
- `apiService.getTrash(params)` - 获取回收站
- `apiService.restoreNote(id)` - 恢复笔记
- `apiService.clearTrash()` - 清空回收站

### 分类与标签
- `apiService.getCategories()` - 获取分类
- `apiService.getTags()` - 获取标签
- `apiService.createTag(tagData)` - 创建标签

### 用户信息
- `apiService.getUserProfile()` - 获取用户资料
- `apiService.updateUserProfile(profileData)` - 更新资料
- `apiService.getUserStats()` - 获取统计信息

### 云同步
- `apiService.syncUpload(notes)` - 上传到云端
- `apiService.syncDownload()` - 从云端下载
- `apiService.getSyncStatus()` - 获取同步状态

## ⚙️ 修改API地址

如果后端部署到服务器，修改 `utils/apiConfig.js`：

```javascript
// 开发环境（本地测试）
const DEV_API_BASE_URL = 'http://localhost:3000/api/v1'

// 生产环境（改成你的服务器地址）
const PROD_API_BASE_URL = 'https://your-domain.com/api/v1'

// 切换环境
const API_BASE_URL = PROD_API_BASE_URL  // 使用生产环境
```

## 🛡️ 安全说明

1. **Token管理**：Token会自动保存在本地存储，API调用时自动附加
2. **过期处理**：Token过期时会自动跳转到登录页
3. **错误处理**：所有API调用都已封装错误处理
4. **HTTPS要求**：生产环境必须使用HTTPS域名

## 📝 常见问题

### Q1: 提示"网络请求失败"？
**A:** 检查：
1. 后端服务器是否启动（npm start）
2. 微信开发者工具是否勾选"不校验合法域名"
3. 防火墙是否阻止了3000端口

### Q2: 提示"未授权"？
**A:** 需要先登录，API会自动管理token

### Q3: 如何查看请求详情？
**A:** 
1. 打开微信开发者工具的Console
2. 查看Network面板
3. 查看后端服务器的日志

### Q4: 如何在正式环境使用？
**A:** 
1. 部署后端到服务器（使用HTTPS）
2. 修改 `apiConfig.js` 中的 PROD_API_BASE_URL
3. 在小程序后台配置服务器域名
4. 切换到生产环境地址

## 🎉 完成！

现在你的小程序已经可以：
- ✅ 连接后端API
- ✅ 用户注册登录
- ✅ 创建和管理笔记
- ✅ 云端同步数据
- ✅ 完整的错误处理

**建议的开发流程：**
1. 先用测试页面验证所有API正常
2. 逐个页面集成API调用
3. 保留本地存储作为缓存（离线支持）
4. 测试完成后部署到服务器

## 📚 更多文档

- 详细API使用示例：`API_USAGE_GUIDE.md`
- 后端API文档：后端项目的README
- 测试页面源码：`pages/api-test/`

祝开发顺利！🚀

