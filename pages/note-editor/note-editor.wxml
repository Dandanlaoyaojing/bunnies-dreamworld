<!--pages/note-editor/note-editor.wxml-->
<view class="note-editor-container">
  <!-- 导航栏 -->
  <view class="nav-bar">
    <view class="nav-content">
      <view class="nav-left" bindtap="goBack">
        <text class="nav-icon">←</text>
      </view>
      <text class="nav-title">{{isDraftMode ? '草稿编辑' : '记笔记'}}</text>
      <view class="nav-right">
        <!-- 草稿模式按钮 -->
        <view wx:if="{{isDraftMode}}" class="nav-btn-group">
          <view class="nav-btn draft-save-btn" bindtap="saveDraft">
            <text class="nav-btn-text">保存草稿</text>
          </view>
          <view class="nav-btn publish-btn" bindtap="publishDraft">
            <text class="nav-btn-text">发布</text>
          </view>
        </view>
        <!-- 普通模式按钮 -->
        <view wx:else class="nav-btn-group">
          <view class="nav-btn share-btn" bindtap="shareNote" wx:if="{{noteTitle || noteContent}}">
            <text class="nav-btn-text">分享</text>
          </view>
          <view class="nav-btn new-note-btn" bindtap="createNewNote">
            <text class="nav-btn-text">新笔记</text>
          </view>
          <view class="nav-btn save-btn" bindtap="saveNote">
            <text class="nav-btn-text">保存</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 草稿状态提示 -->
  <view class="draft-status" wx:if="{{isDraftMode}}">
    <view class="status-content">
      <text class="status-icon">📝</text>
      <text class="status-text">草稿模式 - 自动保存已启用</text>
      <text class="status-time" wx:if="{{lastAutoSaveTime}}">上次保存: {{lastAutoSaveTime}}</text>
    </view>
  </view>

  <!-- 标题输入卡片 -->
  <view class="title-card">
    <view class="card-header">
      <text class="card-title">笔记标题</text>
    </view>
    <input class="title-input" 
           placeholder="给你的笔记起个标题..." 
           value="{{noteTitle}}" 
           bindinput="onTitleInput" 
           maxlength="50" />
  </view>

  <!-- 分类选择卡片 -->
  <view class="category-card">
    <view class="card-header">
      <text class="card-title">选择分类（可多选）</text>
    </view>
    <view class="categories-grid">
      <view class="category-item {{isArtSelected ? 'selected' : ''}}" 
            bindtap="selectCategory" data-category="art">
        <image src="/images/menu/art.png" class="category-icon" />
        <text class="category-name">艺术</text>
      </view>
      <view class="category-item {{isCuteSelected ? 'selected' : ''}}" 
            bindtap="selectCategory" data-category="cute">
        <image src="/images/menu/cute.png" class="category-icon" />
        <text class="category-name">萌物</text>
      </view>
      <view class="category-item {{isDreamsSelected ? 'selected' : ''}}" 
            bindtap="selectCategory" data-category="dreams">
        <image src="/images/menu/dreams.png" class="category-icon" />
        <text class="category-name">梦游</text>
      </view>
      <view class="category-item {{isFoodsSelected ? 'selected' : ''}}" 
            bindtap="selectCategory" data-category="foods">
        <image src="/images/menu/foods.png" class="category-icon" />
        <text class="category-name">美食</text>
      </view>
      <view class="category-item {{isHappinessSelected ? 'selected' : ''}}" 
            bindtap="selectCategory" data-category="happiness">
        <image src="/images/menu/happiness.png" class="category-icon" />
        <text class="category-name">趣事</text>
      </view>
      <view class="category-item {{isKnowledgeSelected ? 'selected' : ''}}" 
            bindtap="selectCategory" data-category="knowledge">
        <image src="/images/menu/knowledge.png" class="category-icon" />
        <text class="category-name">知识</text>
      </view>
      <view class="category-item {{isSightsSelected ? 'selected' : ''}}" 
            bindtap="selectCategory" data-category="sights">
        <image src="/images/menu/sights.png" class="category-icon" />
        <text class="category-name">风景</text>
      </view>
      <view class="category-item {{isThinkingSelected ? 'selected' : ''}}" 
            bindtap="selectCategory" data-category="thinking">
        <image src="/images/menu/thinking.png" class="category-icon" />
        <text class="category-name">思考</text>
      </view>
    </view>
  </view>

  <!-- 内容编辑卡片 -->
  <view class="content-card">
    <view class="card-header">
      <text class="card-title">笔记内容</text>
      <view class="content-actions">
        <view class="action-btn image-btn" bindtap="chooseImage">
          <image src="/images/notes/camera.png" class="action-icon" />
          <text class="action-text">图片</text>
        </view>
        <view class="action-btn voice-btn" bindtap="startVoiceRecording" wx:if="{{!isRecording}}">
          <image src="/images/notes/phone.png" class="action-icon" />
          <text class="action-text">语音</text>
        </view>
        <view class="action-btn stop-btn" bindtap="stopRecording" wx:if="{{isRecording}}">
          <image src="/images/notes/dics.png" class="action-icon" />
          <text class="action-text">停止</text>
        </view>
      </view>
    </view>
    <textarea class="content-editor" 
              placeholder="在这里记录你的想法和灵感..." 
              value="{{noteContent}}" 
              bindinput="onContentInput"
              auto-height="{{true}}"
              maxlength="5000">
    </textarea>
  </view>

  <!-- 智能标签卡片 -->
  <view class="tags-card">
    <view class="card-header">
      <text class="card-title">智能标签</text>
      <view class="tag-actions">
        <view class="action-btn generate-btn" bindtap="generateSmartTags">
          <text class="action-text">AI生成</text>
        </view>
        <view class="action-btn add-btn" bindtap="addTag">
          <text class="action-text">+ 添加</text>
        </view>
        <view class="action-btn clear-btn" bindtap="clearAllTags" wx:if="{{tags.length > 0}}">
          <text class="action-text">清空</text>
        </view>
      </view>
    </view>
    
    <view class="tags-container" wx:if="{{tags.length > 0}}">
      <view class="tag-item {{item.source === 'manual' ? 'manual-tag' : 'ai-tag'}}" wx:for="{{tags}}" wx:key="index" bindtap="removeTag" data-index="{{index}}">
        <text class="tag-text">#{{item.name || item}}</text>
        <text class="tag-remove">×</text>
      </view>
    </view>
    
    <view class="tags-empty" wx:if="{{tags.length === 0}}">
      <text class="empty-text">点击"AI生成"或"添加"来创建标签</text>
    </view>
  </view>

  <!-- 笔记来源卡片（输入框形式） -->
  <view class="source-card">
    <view class="card-header">
      <text class="card-title">笔记来源</text>
    </view>
    <view class="source-input-container">
      <input class="source-input" 
             placeholder="请输入笔记来源..." 
             value="{{source}}" 
             bindinput="onSourceInputChange"
             bindblur="onSourceBlur"
             confirm-type="done" />
    </view>
  </view>

  <!-- 附件管理卡片 -->
  <view class="attachments-card" wx:if="{{images.length > 0 || voices.length > 0}}">
    <view class="card-header">
      <text class="card-title">附件</text>
      <text class="attachment-count">{{images.length + voices.length}}个</text>
    </view>
    
    <!-- 图片附件 -->
    <view class="attachment-section" wx:if="{{images.length > 0}}">
      <view class="attachment-header">
        <text class="attachment-title">图片</text>
        <text class="attachment-count">{{images.length}}张</text>
      </view>
      <view class="images-grid">
        <view class="image-attachment" wx:for="{{images}}" wx:key="id">
          <image class="attachment-image" src="{{item.path}}" mode="aspectFill" bindtap="previewImage" data-src="{{item.path}}" />
          <view class="attachment-actions">
            <view class="attachment-btn ocr-btn" bindtap="convertImageToText" data-id="{{item.id}}">
              <image src="/images/notes/dics.png" class="btn-icon" />
            </view>
            <view class="attachment-btn delete-btn" bindtap="deleteImage" data-id="{{item.id}}">
              <image src="/images/notes/dics.png" class="btn-icon" />
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 语音附件 -->
    <view class="attachment-section" wx:if="{{voices.length > 0}}">
      <view class="attachment-header">
        <text class="attachment-title">语音</text>
        <text class="attachment-count">{{voices.length}}条</text>
      </view>
      <view class="voices-list">
        <view class="voice-attachment" wx:for="{{voices}}" wx:key="id">
          <view class="voice-info">
            <image src="/images/notes/phone.png" class="voice-icon" />
            <view class="voice-details">
              <text class="voice-duration">{{item.duration}}s</text>
              <text class="voice-time">{{item.createTime}}</text>
            </view>
          </view>
          <view class="attachment-actions">
            <view class="attachment-btn play-btn" bindtap="playVoice" data-id="{{item.id}}">
              <image src="/images/notes/dics.png" class="btn-icon" />
            </view>
            <view class="attachment-btn convert-btn" bindtap="convertVoiceToText" data-id="{{item.id}}">
              <image src="/images/notes/dics.png" class="btn-icon" />
            </view>
            <view class="attachment-btn delete-btn" bindtap="deleteVoice" data-id="{{item.id}}">
              <image src="/images/notes/dics.png" class="btn-icon" />
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 保存选项卡片 -->
  <view class="save-options-card">
    <view class="card-header">
      <text class="card-title">保存选项</text>
    </view>
    <view class="save-options">
      <view class="save-option" bindtap="toggleSaveImages">
        <view class="option-info">
          <text class="option-title">同时保存图片</text>
          <text class="option-desc">将图片文件一起保存到笔记中</text>
        </view>
        <view class="option-switch {{saveImages ? 'active' : ''}}">
          <view class="switch-thumb"></view>
        </view>
      </view>
      <view class="save-option" bindtap="toggleSaveVoices">
        <view class="option-info">
          <text class="option-title">同时保存原语音</text>
          <text class="option-desc">将原始语音文件一起保存到笔记中</text>
        </view>
        <view class="option-switch {{saveVoices ? 'active' : ''}}">
          <view class="switch-thumb"></view>
        </view>
      </view>
    </view>
  </view>

  <!-- 底部状态栏 -->
  <view class="status-bar">
    <view class="status-item">
      <text class="status-label">字数</text>
      <text class="status-value">{{wordCount}}</text>
    </view>
    <view class="status-item">
      <text class="status-label">创建时间</text>
      <text class="status-value">{{createTime}}</text>
    </view>
    <view class="status-item">
      <text class="status-label">状态</text>
      <text class="status-value {{isSynced ? 'synced' : 'unsynced'}}">
        {{isSynced ? '已同步' : '未同步'}}
      </text>
    </view>
  </view>
</view>
