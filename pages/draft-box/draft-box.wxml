<!--pages/draft-box/draft-box.wxml-->
<view class="draft-box-container">
  <!-- 顶部导航 -->
  <view class="nav-bar">
    <view class="nav-content">
      <view class="nav-left" bindtap="goBack">
        <text class="nav-icon">←</text>
      </view>
      <text class="nav-title">草稿箱</text>
      <view class="nav-right" bindtap="createNewDraft">
        <text class="nav-icon">✏️</text>
      </view>
    </view>
  </view>

  <!-- 梦境统计卡片 -->
  <view class="dream-stats-card" wx:if="{{!isEmpty}}">
    <view class="stats-header">
      <text class="stats-title">📊 草稿统计</text>
      <view class="stats-badge">
        <text class="stats-count">{{stats.totalCount}}</text>
        <text class="stats-unit">个草稿</text>
      </view>
    </view>
    <view class="stats-content">
      <view class="stat-item">
        <text class="stat-icon">🕐</text>
        <view class="stat-info">
          <text class="stat-label">最新草稿</text>
          <text class="stat-value">{{stats.newestDraft ? stats.newestDraft.updateTimeFormatted : '无'}}</text>
        </view>
      </view>
      <view class="stat-item">
        <text class="stat-icon">🌟</text>
        <view class="stat-info">
          <text class="stat-label">最早草稿</text>
          <text class="stat-value">{{stats.oldestDraft ? stats.oldestDraft.createTimeFormatted : '无'}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 梦境搜索与筛选 -->
  <view class="dream-search-section" wx:if="{{!isEmpty}}">
    <!-- 搜索框 -->
    <view class="search-container">
      <view class="search-box">
        <text class="search-icon">🔍</text>
        <input class="search-input" placeholder="搜索草稿内容..." 
               value="{{searchKeyword}}" bindinput="onSearchInput"/>
        <view class="search-clear" wx:if="{{searchKeyword}}" bindtap="clearSearch">
          <text class="clear-icon">✕</text>
        </view>
      </view>
    </view>

    <!-- 梦境分类筛选 -->
    <view class="category-filter">
      <scroll-view class="category-scroll" scroll-x="true">
        <view class="category-list">
          <view class="category-item {{filterCategory === item.key ? 'active' : ''}}"
                wx:for="{{categories}}" wx:key="key"
                bindtap="selectCategory" data-category="{{item.key}}">
            <text class="category-icon">{{item.icon}}</text>
            <text class="category-name">{{item.name}}</text>
          </view>
        </view>
      </scroll-view>
    </view>

    <!-- 操作工具栏 -->
    <view class="action-toolbar">
      <view class="toolbar-left">
        <view class="sort-selector" bindtap="showSortOptions">
          <text class="sort-icon">📊</text>
          <text class="sort-text">{{sortBy === 'updateTime' ? '更新时间' : sortBy === 'createTime' ? '创建时间' : sortBy === 'title' ? '标题' : '分类'}}</text>
          <text class="sort-arrow">{{sortOrder === 'desc' ? '↓' : '↑'}}</text>
        </view>
      </view>
      <view class="toolbar-right">
        <view class="action-btn cloud-sync-btn" bindtap="syncDraftsFromCloud">
          <text class="btn-icon">☁️</text>
          <text class="btn-text">云端同步</text>
        </view>
        <view class="action-btn batch-btn" bindtap="toggleBatchMode">
          <text class="btn-icon">📋</text>
          <text class="btn-text">{{isBatchMode ? '取消批量' : '批量操作'}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 批量操作栏 -->
  <view class="batch-toolbar" wx:if="{{isBatchMode}}">
    <view class="batch-info">
      <text class="batch-text">已选择 {{selectedDrafts.length}} 个草稿</text>
    </view>
    <view class="batch-actions">
      <view class="batch-btn select-all" bindtap="toggleSelectAll">
        <text class="btn-text">{{selectedDrafts.length === drafts.length ? '全不选' : '全选'}}</text>
      </view>
      <view class="batch-btn cloud-save" bindtap="batchSaveToCloud">
        <text class="btn-text">批量云端保存</text>
      </view>
      <view class="batch-btn publish" bindtap="batchPublish">
        <text class="btn-text">批量发布</text>
      </view>
      <view class="batch-btn delete" bindtap="batchDelete">
        <text class="btn-text">批量删除</text>
      </view>
    </view>
  </view>

  <!-- 梦境列表 -->
  <view class="dreams-list" wx:if="{{!isEmpty}}">
    <view class="dream-item {{selectedDrafts.indexOf(item.id) > -1 ? 'selected' : ''}}"
          wx:for="{{drafts}}" wx:key="id"
          bindtap="onDraftTap" bindlongpress="onDraftLongPress"
          data-id="{{item.id}}">
      
      <!-- 选择框 -->
      <view class="selection-box" wx:if="{{isBatchMode}}">
        <view class="checkbox {{selectedDrafts.indexOf(item.id) > -1 ? 'checked' : ''}}">
          <text class="checkmark" wx:if="{{selectedDrafts.indexOf(item.id) > -1}}">✓</text>
        </view>
      </view>

      <!-- 梦境内容 -->
      <view class="dream-content">
        <view class="dream-header">
          <view class="dream-title-section">
            <text class="dream-title">{{item.title}}</text>
            <view class="dream-meta">
              <text class="dream-category">{{item.category}}</text>
              <text class="dream-time">{{item.updateTimeFormatted}}</text>
            </view>
          </view>
          <view class="dream-status">
            <text class="status-icon" wx:if="{{item.cloudId}}">☁️</text>
            <text class="status-icon" wx:else>📱</text>
          </view>
        </view>
        
        <view class="dream-preview">
          <text class="preview-text">{{item.preview}}</text>
        </view>
        
        <view class="dream-footer">
          <view class="dream-stats">
            <text class="word-count">{{item.wordCount}} 字</text>
            <text class="create-time">创建于 {{item.createTimeFormatted}}</text>
          </view>
          
          <!-- 操作按钮 -->
          <view class="dream-actions" wx:if="{{!isBatchMode}}">
            <view class="action-btn edit" bindtap="editDraft" data-id="{{item.id}}" catchtap="stopPropagation">
              <text class="btn-icon">✏️</text>
            </view>
            <view class="action-btn cloud-save" bindtap="saveDraftToCloud" data-id="{{item.id}}" catchtap="stopPropagation">
              <text class="btn-icon">☁️</text>
            </view>
            <view class="action-btn publish" bindtap="publishDraft" data-id="{{item.id}}" catchtap="stopPropagation">
              <text class="btn-icon">📤</text>
            </view>
            <view class="action-btn delete" bindtap="deleteDraft" data-id="{{item.id}}" catchtap="stopPropagation">
              <text class="btn-icon">🗑️</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 空状态 -->
  <view class="empty-dream-state" wx:if="{{isEmpty}}">
    <view class="empty-animation">
      <text class="empty-icon">📝</text>
      <view class="floating-stars">
        <text class="star">✨</text>
        <text class="star">⭐</text>
        <text class="star">🌟</text>
      </view>
    </view>
    <view class="empty-content">
      <text class="empty-title">草稿箱空空如也</text>
      <text class="empty-subtitle">还没有保存任何草稿，开始创作你的第一篇笔记吧！</text>
    </view>
    <view class="empty-actions">
      <view class="create-dream-btn" bindtap="createNewDraft">
        <text class="btn-icon">✏️</text>
        <text class="btn-text">创建新草稿</text>
      </view>
    </view>
  </view>

  <!-- 加载状态 -->
  <view class="loading-dream-state" wx:if="{{isLoading}}">
    <view class="loading-animation">
      <text class="loading-icon">📝</text>
      <view class="loading-stars">
        <text class="star">✨</text>
        <text class="star">⭐</text>
        <text class="star">🌟</text>
      </view>
    </view>
    <text class="loading-text">正在加载草稿...</text>
  </view>

  <!-- 底部安全区域 -->
  <view class="safe-area"></view>
</view>