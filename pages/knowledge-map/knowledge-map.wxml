<!--pages/knowledge-map/knowledge-map.wxml-->
<view class="knowledge-map-container">
  <!-- å¯¼èˆªæ  -->
  <view class="nav-bar">
    <view class="nav-content">
      <view class="nav-left" bindtap="goBack">
        <text class="nav-icon">â†</text>
      </view>
      <text class="nav-title">çŸ¥è¯†æ˜Ÿå›¾</text>
      <view class="nav-right" bindtap="refreshMap">
        <text class="refresh-text">åˆ·æ–°</text>
      </view>
    </view>
  </view>

  <!-- æœç´¢å®¹å™¨ -->
  <view class="search-container">
    <view class="search-input-wrapper">
      <input class="search-input" 
             placeholder="æœç´¢ç¬”è®°æ ‡é¢˜ã€å†…å®¹ã€æ ‡ç­¾..."
             value="{{searchKeyword}}"
             bindinput="onSearchInput"
             bindconfirm="onSearchConfirm"
             bindfocus="onSearchFocus"
             bindblur="onSearchBlur" />
      
      <!-- æœç´¢å»ºè®® -->
      <view class="search-suggestions" wx:if="{{showSuggestions && searchSuggestions.length > 0}}">
        <view class="suggestion-item" 
              wx:for="{{searchSuggestions}}" 
              wx:key="*this"
              bindtap="selectSuggestion" 
              data-suggestion="{{item}}">
          <text class="suggestion-icon">ğŸ”</text>
          <text class="suggestion-text">{{item}}</text>
        </view>
      </view>
    </view>
    
    <!-- å¿«é€Ÿæ ‡ç­¾ -->
    <view class="quick-tags" wx:if="{{popularTags.length > 0}}">
      <text class="quick-tag" 
            wx:for="{{popularTags}}" 
            wx:key="name"
            style="background-color: {{item.color}}20; color: {{item.color}};"
            bindtap="selectQuickTag" 
            data-tag="{{item.name}}">
        #{{item.name}}
      </text>
    </view>
  </view>

  <!-- ç­›é€‰æ§åˆ¶é¢æ¿ -->
  <view class="filter-panel">
    <view class="filter-section">
      <text class="filter-title">æ—¶é—´èŒƒå›´</text>
      <view class="time-filters">
        <picker mode="date" bindchange="onStartDateChange" value="{{startDate}}">
          <view class="picker-btn">
            <text class="picker-text">{{startDate || 'å¼€å§‹æ—¥æœŸ'}}</text>
            <text class="picker-arrow">â–¼</text>
          </view>
        </picker>
        <text class="date-separator">è‡³</text>
        <picker mode="date" bindchange="onEndDateChange" value="{{endDate}}">
          <view class="picker-btn">
            <text class="picker-text">{{endDate || 'ç»“æŸæ—¥æœŸ'}}</text>
            <text class="picker-arrow">â–¼</text>
          </view>
        </picker>
      </view>
    </view>

    <view class="filter-section">
      <text class="filter-title">åˆ†ç±»ç­›é€‰ï¼ˆå¯å¤šé€‰ï¼‰</text>
      <view class="category-filters">
        <!-- å…¨éƒ¨æŒ‰é’® -->
        <view class="category-item {{selectedCategories.length === 8 ? 'selected' : ''}}" 
              bindtap="toggleCategory" data-category="">
          <text class="category-name">å…¨éƒ¨</text>
        </view>
        
        <!-- åˆ†ç±»æŒ‰é’® -->
        <view class="category-item {{isArtSelected ? 'selected' : ''}}" 
              bindtap="toggleCategory" data-category="art">
          <text class="category-name">è‰ºæœ¯</text>
        </view>
        
        <view class="category-item {{isCuteSelected ? 'selected' : ''}}" 
              bindtap="toggleCategory" data-category="cute">
          <text class="category-name">èŒç‰©</text>
        </view>
        
        <view class="category-item {{isDreamsSelected ? 'selected' : ''}}" 
              bindtap="toggleCategory" data-category="dreams">
          <text class="category-name">æ¢¦æ¸¸</text>
        </view>
        
        <view class="category-item {{isFoodsSelected ? 'selected' : ''}}" 
              bindtap="toggleCategory" data-category="foods">
          <text class="category-name">ç¾é£Ÿ</text>
        </view>
        
        <view class="category-item {{isHappinessSelected ? 'selected' : ''}}" 
              bindtap="toggleCategory" data-category="happiness">
          <text class="category-name">è¶£äº‹</text>
        </view>
        
        <view class="category-item {{isKnowledgeSelected ? 'selected' : ''}}" 
              bindtap="toggleCategory" data-category="knowledge">
          <text class="category-name">çŸ¥è¯†</text>
        </view>
        
        <view class="category-item {{isSightsSelected ? 'selected' : ''}}" 
              bindtap="toggleCategory" data-category="sights">
          <text class="category-name">é£æ™¯</text>
        </view>
        
        <view class="category-item {{isThinkingSelected ? 'selected' : ''}}" 
              bindtap="toggleCategory" data-category="thinking">
          <text class="category-name">æ€è€ƒ</text>
        </view>
      </view>
    </view>

    <view class="filter-section">
      <text class="filter-title">åˆ†æè®¾ç½®</text>
      <view class="analysis-settings">
        <view class="setting-item">
          <text class="setting-label">æœ€å°å…³è”åº¦</text>
          <slider value="{{minRelation}}" min="0" max="1" step="0.1" 
                  bindchange="onMinRelationChange" show-value />
        </view>
        <view class="setting-item">
          <text class="setting-label">æ˜¾ç¤ºå±‚çº§</text>
          <slider value="{{maxLevel}}" min="1" max="5" step="1" 
                  bindchange="onMaxLevelChange" show-value />
        </view>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{isLoading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">{{loadingText}}</text>
  </view>

  <!-- çŸ¥è¯†æ˜Ÿå›¾å¯è§†åŒ–åŒºåŸŸ -->
  <view class="map-container" wx:if="{{!isLoading && knowledgeMap.nodes.length > 0}}">
    <view class="map-header">
      <text class="map-title">çŸ¥è¯†å…³è”å›¾è°±</text>
      <text class="map-stats">å…± {{knowledgeMap.nodes.length}} ä¸ªçŸ¥è¯†ç‚¹ï¼Œ{{knowledgeMap.links.length}} æ¡å…³è”</text>
    </view>
    
    <!-- å›¾è°±å¯è§†åŒ– -->
    <view class="graph-visualization">
      <view class="knowledge-node {{item.level === 1 ? 'level-1' : item.level === 2 ? 'level-2' : 'level-3'}} {{draggingNode && draggingNode.id === item.id ? 'dragging' : ''}}" 
            wx:for="{{knowledgeMap.nodes}}" wx:key="id"
            style="left: {{item.x}}rpx; top: {{item.y}}rpx;"
            bindtap="onNodeTap" 
            bindtouchstart="onNodeTouchStart"
            bindtouchmove="onNodeTouchMove"
            bindtouchend="onNodeTouchEnd"
            bindlongpress="onNodeLongPress"
            data-node="{{item}}">
        <view class="node-content">
          <text class="node-title">{{item.name}}</text>
          <text class="node-count">{{item.count}}æ¡ç¬”è®°</text>
        </view>
        <view class="node-connections" wx:if="{{item.connections > 0}}">
          <text class="connection-count">{{item.connections}}</text>
        </view>
        <view class="node-importance" wx:if="{{item.importance > 70}}">
          <text class="importance-star">â­</text>
        </view>
      </view>
    </view>

    <!-- å…³è”çº¿ -->
    <view class="connection-lines">
      <view class="connection-line" 
            wx:for="{{knowledgeMap.links}}" wx:key="id"
            style="left: {{item.startX}}rpx; top: {{item.startY}}rpx; width: {{item.length}}rpx; transform: rotate({{item.angle}}deg);">
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{!isLoading && knowledgeMap.nodes.length === 0}}">
    <text class="empty-icon">ğŸŒŸ</text>
    <text class="empty-title">æš‚æ— çŸ¥è¯†å…³è”</text>
    <text class="empty-desc">è¯·è°ƒæ•´ç­›é€‰æ¡ä»¶æˆ–æ·»åŠ æ›´å¤šç¬”è®°</text>
    <button class="generate-btn" bindtap="generateMap">ç”ŸæˆçŸ¥è¯†å›¾è°±</button>
  </view>

  <!-- èŠ‚ç‚¹è¯¦æƒ…å¼¹çª— -->
  <view class="node-detail-modal" wx:if="{{showNodeDetail}}" bindtap="closeNodeDetail">
    <view class="modal-content" catchtap="true">
      <view class="modal-header">
        <text class="modal-title">{{selectedNode.name}}</text>
        <text class="modal-close" bindtap="closeNodeDetail">Ã—</text>
      </view>
      <view class="modal-body">
        <view class="node-info">
          <text class="info-item">ç›¸å…³ç¬”è®°: {{selectedNode.count}}æ¡</text>
          <text class="info-item">å…³è”èŠ‚ç‚¹: {{selectedNode.connections}}ä¸ª</text>
          <text class="info-item">é‡è¦ç¨‹åº¦: {{selectedNode.importance}}%</text>
        </view>
        <view class="related-notes">
          <text class="section-title">ç›¸å…³ç¬”è®°</text>
          <view class="note-item" wx:for="{{selectedNode.notes}}" wx:key="id" 
                bindtap="openNoteDetail" data-id="{{item.id}}">
            <text class="note-title">{{item.title}}</text>
            <text class="note-time">{{item.createTime}}</text>
          </view>
        </view>
        <view class="related-tags">
          <text class="section-title">ç›¸å…³æ ‡ç­¾</text>
          <view class="tag-list">
            <text class="tag-item" wx:for="{{selectedNode.tags}}" wx:key="*this">#{{item}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- æµ®åŠ¨æ“ä½œæŒ‰é’® -->
  <view class="floating-actions">
    <view class="floating-btn generate-btn" bindtap="generateMap">
      <text class="floating-text">ç”Ÿæˆæ˜Ÿå›¾</text>
    </view>
    <view class="floating-btn settings-btn" bindtap="showSettings">
      <text class="floating-text">è®¾ç½®</text>
    </view>
  </view>
</view>
