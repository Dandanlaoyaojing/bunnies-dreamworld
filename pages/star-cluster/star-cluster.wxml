<!--pages/star-cluster/star-cluster.wxml-->
<view class="star-cluster-container">
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <view class="nav-bar">
    <view class="nav-content">
      <view class="nav-left" bindtap="goBack">
        <text class="nav-icon">â†</text>
      </view>
      <text class="nav-title">æ˜Ÿå›¢è”ç›Ÿ</text>
      <view class="nav-right" bindtap="showClusterSettings">
        <text class="nav-icon">è®¾ç½®</text>
      </view>
    </view>
  </view>

  <!-- æ˜Ÿå›¢åˆ—è¡¨ -->
  <view class="cluster-list-section" wx:if="{{!showClusterDetail}}">
    <view class="section-header">
      <text class="section-title">æˆ‘çš„æ˜Ÿå›¢</text>
      <view class="add-cluster-btn" bindtap="createNewCluster">
        <text class="add-btn-text">+ åˆ›å»ºæ˜Ÿå›¢</text>
      </view>
    </view>

    <!-- æ˜Ÿå›¢åˆ—è¡¨ -->
    <view class="cluster-list">
      <view class="cluster-item" wx:for="{{joinedClusters}}" wx:key="id" 
            bindtap="enterCluster" data-cluster="{{item}}">
        <view class="cluster-header">
          <view class="cluster-info">
            <text class="cluster-name">{{item.name}}</text>
            <text class="cluster-desc">{{item.description}}</text>
          </view>
          <view class="cluster-status">
            <text class="status-text">{{item.memberCount}} æˆå‘˜</text>
            <view class="status-dot {{item.isActive ? 'active' : 'inactive'}}"></view>
          </view>
        </view>
        
        <view class="cluster-meta">
          <view class="meta-item">
            <text class="meta-label">é¢†èˆªæ˜Ÿä¸»</text>
            <text class="meta-value">{{item.leaderName}}</text>
          </view>
          <view class="meta-item">
            <text class="meta-label">åˆ›å»ºæ—¶é—´</text>
            <text class="meta-value">{{item.createTime}}</text>
          </view>
          <view class="meta-item">
            <text class="meta-label">èåˆæ¬¡æ•°</text>
            <text class="meta-value">{{item.fusionCount}} æ¬¡</text>
          </view>
        </view>
        
        <view class="cluster-actions">
          <view class="action-btn" bindtap="enterCluster" data-cluster="{{item}}" catchtap="true">
            <text class="action-text">è¿›å…¥æ˜Ÿå›¢</text>
          </view>
          <view class="action-btn secondary" bindtap="leaveCluster" data-cluster="{{item}}" catchtap="true">
            <text class="action-text">é€€å‡ºæ˜Ÿå›¢</text>
          </view>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{joinedClusters.length === 0}}">
      <text class="empty-icon">ğŸŒŒ</text>
      <text class="empty-title">è¿˜æ²¡æœ‰åŠ å…¥ä»»ä½•æ˜Ÿå›¢</text>
      <text class="empty-desc">åˆ›å»ºæˆ–åŠ å…¥æ˜Ÿå›¢ï¼Œå¼€å§‹åä½œæ¢ç´¢çŸ¥è¯†çš„å®‡å®™</text>
      <view class="empty-actions">
        <view class="action-btn primary" bindtap="createNewCluster">
          <text class="action-text">åˆ›å»ºæ˜Ÿå›¢</text>
        </view>
        <view class="action-btn" bindtap="discoverClusters">
          <text class="action-text">å‘ç°æ˜Ÿå›¢</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æ˜Ÿå›¢è¯¦æƒ…é¡µé¢ -->
  <view class="cluster-detail-section" wx:if="{{showClusterDetail}}">
    <!-- æ˜Ÿå›¢ä¿¡æ¯å¤´éƒ¨ -->
    <view class="cluster-detail-header">
      <view class="header-center">
        <text class="cluster-name">{{currentCluster.name}}</text>
        <text class="cluster-desc">{{currentCluster.description}}</text>
      </view>
    </view>

    <!-- æ˜Ÿå›¢æˆå‘˜ -->
    <view class="members-section">
      <view class="section-header">
        <text class="section-title">æ˜Ÿå›¢æˆå‘˜</text>
        <view class="invite-btn" bindtap="inviteMember">
          <text class="invite-text">é‚€è¯·æˆå‘˜</text>
        </view>
      </view>

      <view class="members-list">
        <!-- é¢†èˆªæ˜Ÿä¸» -->
        <view class="member-item leader">
          <view class="member-avatar">
            <text class="member-initial">{{currentCluster.leaderName.charAt(0)}}</text>
            <view class="leader-badge">æ˜Ÿä¸»</view>
          </view>
          <view class="member-info">
            <text class="member-name">{{currentCluster.leaderName}}</text>
            <text class="member-role">é¢†èˆªæ˜Ÿä¸»</text>
          </view>
          <view class="member-status">
            <text class="status-text">åœ¨çº¿</text>
          </view>
        </view>

        <!-- æ™®é€šæˆå‘˜ - æ¨ªå‘æ’åˆ— -->
        <view class="members-grid">
          <view class="member-card" wx:for="{{currentCluster.members}}" wx:key="id">
            <view class="member-avatar-small">
              <text class="member-initial">{{item.name.charAt(0)}}</text>
              <view class="online-indicator" wx:if="{{item.isOnline}}"></view>
            </view>
            <view class="member-info-compact">
              <text class="member-name">{{item.name}}</text>
              <text class="member-status-text">{{item.isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿'}}</text>
            </view>
            <view class="member-actions-compact" wx:if="{{isLeader}}">
              <view class="remove-btn" bindtap="removeMember" data-member="{{item}}" catchtap="true">
                <text class="remove-text">Ã—</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- æ˜Ÿå›¾èåˆåŒºåŸŸ -->
    <view class="fusion-section">
      <view class="section-header">
        <text class="section-title">æ˜Ÿå›¾èåˆ</text>
        <view class="fusion-status">
          <text class="status-text">å‡†å¤‡èåˆ</text>
        </view>
      </view>

      <!-- æˆ‘çš„æ˜Ÿå›¾é€‰æ‹© -->
      <view class="my-stars-selection">
        <view class="selection-header">
          <text class="selection-title">é€‰æ‹©æˆ‘çš„æ˜Ÿå›¾</text>
          <text class="selection-desc">ä»æˆ‘çš„æ˜Ÿå›¾ä¸­é€‰æ‹©ä¸€å¼ å‚ä¸èåˆ</text>
        </view>

        <!-- æˆ‘çš„æ˜Ÿå›¾åˆ—è¡¨ - å¯æ»‘åŠ¨ -->
        <view class="stars-scroll-container">
          <scroll-view class="my-stars-scroll" scroll-x="true" show-scrollbar="false" 
                       bindscroll="onStarsScroll" bindscrolltolower="onScrollToLower">
            <view class="my-stars-list">
              <view class="star-option" wx:for="{{myAvailableStars}}" wx:key="id" 
                    bindtap="selectMyStar" data-star="{{item}}" catchtap="true">
                <view class="star-preview">
                  <text class="star-name">{{item.name}}</text>
                  <text class="star-nodes">{{item.nodeCount}} ä¸ªèŠ‚ç‚¹</text>
                </view>
                <view class="star-tags">
                  <text class="tag" wx:for="{{item.tags}}" wx:key="*this">#{{item}}</text>
                </view>
                <view class="star-meta">
                  <text class="star-date">åˆ›å»ºäº {{item.createTime}}</text>
                </view>
              </view>
            </view>
          </scroll-view>
          <!-- æ»‘åŠ¨æç¤º -->
          <view class="scroll-hint" wx:if="{{myAvailableStars.length > 1}}">
            <view class="scroll-dots">
              <view class="dot" wx:for="{{scrollDots}}" wx:key="index" 
                    class="{{item.active ? 'active' : ''}}"></view>
            </view>
            <text class="scroll-text">å·¦å³æ»‘åŠ¨æŸ¥çœ‹æ›´å¤š</text>
          </view>
        </view>

        <!-- å·²é€‰æ‹©çš„æ˜Ÿå›¾ -->
        <view class="selected-star" wx:if="{{mySelectedStar}}">
          <view class="selected-header">
            <text class="selected-title">å·²é€‰æ‹©çš„æ˜Ÿå›¾</text>
            <view class="change-btn" bindtap="changeMyStar" catchtap="true">
              <text class="change-text">æ›´æ¢</text>
            </view>
          </view>
          <view class="star-preview">
            <text class="star-name">{{mySelectedStar.name}}</text>
            <text class="star-nodes">{{mySelectedStar.nodeCount}} ä¸ªèŠ‚ç‚¹</text>
          </view>
          <view class="star-tags">
            <text class="tag" wx:for="{{mySelectedStar.tags}}" wx:key="*this">#{{item}}</text>
          </view>
          <view class="star-meta">
            <text class="star-date">åˆ›å»ºäº {{mySelectedStar.createTime}}</text>
          </view>
        </view>
      </view>

      <!-- èåˆçŠ¶æ€ -->
      <view class="fusion-status">
        <view class="status-header">
          <text class="status-title">èåˆçŠ¶æ€</text>
        </view>
        <view class="status-info">
          <view class="status-item">
            <text class="status-label">æˆ‘çš„çŠ¶æ€</text>
            <text class="status-value" wx:if="{{mySelectedStar}}">å·²å‚ä¸èåˆ</text>
            <text class="status-value pending" wx:else>æœªå‚ä¸èåˆ</text>
          </view>
          <view class="status-item">
            <text class="status-label">å‚ä¸æˆå‘˜</text>
            <text class="status-value">{{participatingMembersCount}} äºº</text>
          </view>
          <view class="status-item">
            <text class="status-label">èåˆèŠ‚ç‚¹</text>
            <text class="status-value">{{currentFusionNodes}} ä¸ª</text>
          </view>
        </view>
        
        <!-- å‚ä¸èåˆçš„æˆå‘˜åˆ—è¡¨ -->
        <view class="participating-members" wx:if="{{participatingMembers.length > 0}}">
          <text class="members-title">å‚ä¸èåˆçš„æˆå‘˜ï¼š</text>
          <view class="members-tags">
            <text class="member-tag" wx:for="{{participatingMembers}}" wx:key="id">
              {{item.name}}
            </text>
          </view>
        </view>
      </view>

      <!-- èåˆæ§åˆ¶ -->
      <view class="fusion-controls">
        <view class="control-info">
          <text class="info-text">å®æ—¶èåˆï¼Œéšæ—¶åŠ å…¥æˆ–é€€å‡º</text>
        </view>
        <view class="control-actions">
          <view class="action-btn secondary" bindtap="exitFusion" wx:if="{{mySelectedStar}}">
            <text class="action-text">é€€å‡ºèåˆ</text>
          </view>
          <view class="action-btn primary" bindtap="refreshFusion" wx:if="{{participatingMembersCount > 0}}">
            <text class="action-text">åˆ·æ–°èåˆ</text>
          </view>
          <view class="action-btn primary" bindtap="startFusion" wx:if="{{!mySelectedStar}}">
            <text class="action-text">åŠ å…¥èåˆ</text>
          </view>
          <view class="action-btn disabled" wx:if="{{participatingMembersCount === 0 && !mySelectedStar}}">
            <text class="action-text">æš‚æ— èåˆ</text>
          </view>
        </view>
      </view>
    </view>

    <!-- èåˆå†å² -->
    <view class="fusion-history">
      <view class="section-header">
        <text class="section-title">èåˆå†å²</text>
      </view>
      
      <view class="history-list">
        <view class="history-item" wx:for="{{fusionHistory}}" wx:key="id">
          <view class="history-header">
            <text class="history-title">{{item.name}}</text>
            <text class="history-time">{{item.createTime}}</text>
          </view>
          <view class="history-stats">
            <text class="stat-item">{{item.participantCount}} äººå‚ä¸</text>
            <text class="stat-item">{{item.nodeCount}} ä¸ªèŠ‚ç‚¹</text>
            <text class="stat-item">{{item.connectionCount}} æ¡è¿æ¥</text>
          </view>
          <view class="history-actions">
            <view class="action-btn small" bindtap="viewFusionResult" data-fusion="{{item}}" catchtap="true">
              <text class="action-text">æŸ¥çœ‹ç»“æœ</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- åˆ›å»ºæ˜Ÿå›¢å¼¹çª— -->
  <view class="create-cluster-modal" wx:if="{{showCreateModal}}" bindtap="closeCreateModal">
    <view class="modal-content" catchtap="preventClose">
      <view class="modal-header">
        <text class="modal-title">åˆ›å»ºæ–°æ˜Ÿå›¢</text>
        <view class="modal-close" bindtap="closeCreateModal">
          <text class="close-icon">Ã—</text>
        </view>
      </view>
      
      <view class="modal-body">
        <view class="form-item">
          <text class="form-label">æ˜Ÿå›¢åç§°</text>
          <input class="form-input" placeholder="è¯·è¾“å…¥æ˜Ÿå›¢åç§°" value="{{newCluster.name}}" 
                 bindinput="onClusterNameInput" />
        </view>
        
        <view class="form-item">
          <text class="form-label">æ˜Ÿå›¢æè¿°</text>
          <textarea class="form-textarea" placeholder="æè¿°è¿™ä¸ªæ˜Ÿå›¢çš„ç›®æ ‡å’Œç‰¹è‰²" 
                    value="{{newCluster.description}}" bindinput="onClusterDescInput"></textarea>
        </view>
        
        <view class="form-item">
          <text class="form-label">åŠ å…¥æ–¹å¼</text>
          <view class="radio-group">
            <view class="radio-item" bindtap="setJoinMode" data-mode="approve">
              <view class="radio-dot {{newCluster.joinMode === 'approve' ? 'checked' : ''}}"></view>
              <text class="radio-text">éœ€è¦æ˜Ÿä¸»æ‰¹å‡†</text>
            </view>
            <view class="radio-item" bindtap="setJoinMode" data-mode="free">
              <view class="radio-dot {{newCluster.joinMode === 'free' ? 'checked' : ''}}"></view>
              <text class="radio-text">è‡ªç”±åŠ å…¥</text>
            </view>
          </view>
        </view>
      </view>
      
      <view class="modal-actions">
        <view class="action-btn secondary" bindtap="closeCreateModal">
          <text class="action-text">å–æ¶ˆ</text>
        </view>
        <view class="action-btn primary" bindtap="confirmCreateCluster">
          <text class="action-text">åˆ›å»ºæ˜Ÿå›¢</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æ˜Ÿå›¾èåˆç»“æœå¼¹çª— -->
  <view class="fusion-result-modal" wx:if="{{showFusionResult}}" bindtap="closeFusionResult">
    <view class="modal-content" catchtap="preventClose">
      <view class="modal-header">
        <text class="modal-title">èåˆç»“æœ</text>
        <view class="modal-close" bindtap="closeFusionResult">
          <text class="close-icon">Ã—</text>
        </view>
      </view>
      
      <view class="modal-body">
        <view class="result-stats">
          <view class="stat-item">
            <text class="stat-number">{{fusionResult.nodeCount}}</text>
            <text class="stat-label">èåˆèŠ‚ç‚¹</text>
          </view>
          <view class="stat-item">
            <text class="stat-number">{{fusionResult.connectionCount}}</text>
            <text class="stat-label">è¿æ¥å…³ç³»</text>
          </view>
          <view class="stat-item">
            <text class="stat-number">{{fusionResult.participantCount}}</text>
            <text class="stat-label">å‚ä¸æˆå‘˜</text>
          </view>
        </view>
        
        <view class="result-preview">
          <text class="preview-title">èåˆé¢„è§ˆ</text>
          <view class="preview-nodes">
            <view class="preview-node" wx:for="{{fusionResult.nodes}}" wx:key="id">
              <text class="node-name">{{item.name}}</text>
              <text class="node-source">æ¥æº: {{item.source}}</text>
            </view>
          </view>
        </view>
      </view>
      
      <view class="modal-actions">
        <view class="action-btn secondary" bindtap="closeFusionResult">
          <text class="action-text">å…³é—­</text>
        </view>
        <view class="action-btn primary" bindtap="saveFusionResult">
          <text class="action-text">ä¿å­˜ç»“æœ</text>
        </view>
      </view>
    </view>
  </view>
</view>