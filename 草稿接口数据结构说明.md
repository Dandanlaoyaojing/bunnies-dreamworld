# 草稿接口数据结构说明

## 📋 后端实际返回格式

### GET /api/v1/drafts 接口返回格式

```json
{
  "success": true,
  "message": "获取草稿列表成功",
  "data": {
    "drafts": [
      {
        "id": "draft_001",
        "title": "草稿标题",
        "content": "草稿内容",
        "category": "knowledge",
        "tags": "[\"标签1\", \"标签2\"]",  // JSON字符串，需要解析
        "word_count": 150,
        "created_at": "2024-01-01T00:00:00.000Z",
        "updated_at": "2024-01-01T00:00:00.000Z",
        "user_id": "username"
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 10,
      "total": 25,
      "total_pages": 3
    }
  }
}
```

## 🔍 关键差异分析

### 1. **data 字段结构不同**
- **预期**：`data: [...]` (数组)
- **实际**：`data: { drafts: [...], pagination: {...} }` (对象)

### 2. **tags 字段格式不同**
- **预期**：`tags: ["标签1", "标签2"]` (数组)
- **实际**：`tags: "[\"标签1\", \"标签2\"]"` (JSON字符串)

### 3. **额外字段**
- `pagination` - 分页信息
- `word_count` - 字数统计
- `created_at`, `updated_at` - 时间字段
- `user_id` - 用户ID字段

## 🛠️ 前端修复方案

需要修改 `utils/draftCloudService.js` 中的数据处理逻辑：

### 1. 修复 downloadDrafts 方法

```javascript
// 修复前
if (result.success) {
  const drafts = Array.isArray(result.data) ? result.data : []
  return {
    success: true,
    drafts: drafts,
    count: drafts.length
  }
}

// 修复后
if (result.success) {
  // 处理新的数据结构
  const responseData = result.data || {}
  const draftsArray = responseData.drafts || []
  
  // 解析tags字段
  const processedDrafts = draftsArray.map(draft => ({
    ...draft,
    tags: this.parseTags(draft.tags),
    // 统一字段名
    createTime: draft.created_at,
    updateTime: draft.updated_at,
    userId: draft.user_id
  }))
  
  return {
    success: true,
    drafts: processedDrafts,
    count: processedDrafts.length,
    pagination: responseData.pagination
  }
}
```

### 2. 添加tags解析方法

```javascript
// 解析tags字段
parseTags(tagsString) {
  try {
    if (typeof tagsString === 'string') {
      return JSON.parse(tagsString)
    } else if (Array.isArray(tagsString)) {
      return tagsString
    } else {
      return []
    }
  } catch (error) {
    console.warn('解析tags失败:', error)
    return []
  }
}
```

### 3. 修复 syncDraftsFromCloud 方法

```javascript
// 修复前
const cloudDrafts = downloadResult.drafts || []

// 修复后
const cloudDrafts = downloadResult.drafts || []
console.log('云端草稿数据类型:', typeof cloudDrafts, Array.isArray(cloudDrafts))
console.log('云端草稿数据内容:', cloudDrafts)

// 确保 cloudDrafts 是数组
if (!Array.isArray(cloudDrafts)) {
  console.error('❌ 云端草稿数据不是数组:', cloudDrafts)
  throw new Error('云端草稿数据格式错误，期望数组但得到: ' + typeof cloudDrafts)
}
```

## 📝 完整的数据结构映射

### 后端字段 → 前端字段映射

| 后端字段 | 前端字段 | 说明 |
|---------|---------|------|
| `id` | `id` | 草稿ID |
| `title` | `title` | 标题 |
| `content` | `content` | 内容 |
| `category` | `category` | 分类 |
| `tags` (JSON字符串) | `tags` (数组) | 标签，需要解析 |
| `word_count` | `wordCount` | 字数 |
| `created_at` | `createTime` | 创建时间 |
| `updated_at` | `updateTime` | 更新时间 |
| `user_id` | `userId` | 用户ID |

### 分页信息处理

```javascript
// 分页信息
const pagination = responseData.pagination || {}
console.log('分页信息:', pagination)
// 可以用于实现分页加载功能
```

## 🚀 实施步骤

1. **修改 downloadDrafts 方法**
   - 处理新的数据结构
   - 解析tags字段
   - 统一字段名

2. **添加数据转换方法**
   - 添加parseTags方法
   - 添加字段映射逻辑

3. **更新调试工具**
   - 更新调试工具以显示新的数据结构
   - 添加tags解析测试

4. **测试验证**
   - 使用调试工具测试修复效果
   - 验证草稿同步功能

## ✅ 修复效果

修复后，前端将能够：
- ✅ 正确处理新的数据结构
- ✅ 解析JSON字符串格式的tags
- ✅ 统一字段名映射
- ✅ 处理分页信息
- ✅ 避免forEach错误

## 📞 后续建议

1. **与后端协调**：确认数据结构是否还会变化
2. **添加类型检查**：增强数据验证逻辑
3. **优化性能**：考虑分页加载优化
4. **完善错误处理**：添加更详细的错误信息
